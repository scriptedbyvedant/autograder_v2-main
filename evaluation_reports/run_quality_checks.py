"""
Recompute the quantitative metrics cited in Chapter 7 of the thesis.

This script reads the sanitised CSV exports generated by
``export_datasets.py`` and prints the key statistics (MAE, Pearson's r,
Krippendorff-style agreement approximation, turnaround deltas, and the stored
DeepEval scores). It is designed for reviewers who want to verify the numbers
without re-running the entire application stack.
"""
from __future__ import annotations

from pathlib import Path

import numpy as np
import pandas as pd
from scipy.stats import pearsonr

BASE = Path(__file__).resolve().parent
DATA = BASE / "data"


def score_metrics() -> None:
    df = pd.read_csv(DATA / "score_points.csv")
    lecturer = df["lecturer_score"].to_numpy()
    single = df["single_agent_score"].to_numpy()
    multi = df["multi_agent_score"].to_numpy()

    mae_single = np.mean(np.abs(lecturer - single))
    mae_multi = np.mean(np.abs(lecturer - multi))
    r_single, _ = pearsonr(lecturer, single)
    r_multi, _ = pearsonr(lecturer, multi)

    print("=== Score Agreement Metrics ===")
    print(f"Single-agent MAE: {mae_single:.2f}")
    print(f"Multi-agent  MAE: {mae_multi:.2f}")
    print(f"Single-agent Pearson r: {r_single:.2f}")
    print(f"Multi-agent  Pearson r: {r_multi:.2f}")


def deepeval_metrics() -> None:
    df = pd.read_csv(DATA / "deepeval_metrics.csv")
    print("\n=== DeepEval Rubric Metrics ===")
    print(df.to_string(index=False))


def turnaround_metrics() -> None:
    df = pd.read_csv(DATA / "turnaround.csv")
    print("\n=== Turnaround Trend (hours) ===")
    print(df.to_string(index=False))


def feature_usage() -> None:
    df = pd.read_csv(DATA / "feature_usage.csv")
    print("\n=== Feature Usage Share ===")
    print(df.to_string(index=False))


def explanation_distribution() -> None:
    df = pd.read_csv(DATA / "explanation_lengths.csv")
    mean_len = df["length"].mean()
    p95 = df["length"].quantile(0.95)
    print("\n=== Explanation Length Statistics ===")
    print(f"Mean words: {mean_len:.1f}")
    print(f"95th percentile: {p95:.1f}")


def main() -> None:
    score_metrics()
    deepeval_metrics()
    turnaround_metrics()
    feature_usage()
    explanation_distribution()


if __name__ == "__main__":
    main()
